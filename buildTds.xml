<?xml version="1.0" encoding="UTF-8"?>
<project name="ncISO for TDS" default="cleanBuildNcisoSrcAndJar" basedir=".">
    <description>Build nciso.jar for use by TDS.</description>

  <tstamp>
    <format property="build.time" pattern="yyyy-MM-dd HH:mm:ss" timezone="GMT"/>
    <format property="build.time.number" pattern="yyyyMMdd.HHmm" timezone="GMT"/>
  </tstamp>
  <property name="build.number" value="${build.time.number}" />
  <property name="build.name" value="${build.number}" />

  <property name="release.version" value="4.2"/>
  <property name="release.version.minor" value="${release.version}.${build.number}"/>
  <property name="release.dir.name" value="${release.version}.${build.name}"/>

  <property  name="ncisoForTds.release.version" value="1.0.tds.${release.version.minor}" />

  <property name="javac.debug" value="true" />
  <property name="javac.debuglevel" value="lines,vars,source" />

  <property name="src.dir" location="${basedir}/src/main/java"/>
  <property name="thredds.dir" value="../threddsFullDev/thredds" />
  <property name="thredds.classes.dir" value="${thredds.dir}/tds/target/classes" />
  <property name="thredds.lib.dir" value="${thredds.dir}/lib" />

  <property name="build.dir" value="${basedir}/target"/>
  <property name="build.classes.dir" value="${build.dir}/classes"/>

  <path id="source.path">
    <pathelement location="${src.dir}"/>
  </path>

  <patternset id="sources">
    <include name="thredds/server/metadata/**/*.java"/>
  </patternset>

  <fileset id="compile.libraries" dir="${thredds.lib.dir}">
    <patternset id="compile.libs">

      <include name="release/netcdf-4.2.jar" />
      <include name="external/servlet-api.jar" />
      <include name="external/slf4j-api-1.5.6.jar" />
      <include name="external/log4j-1.2.15.jar" />
      <include name="external/spring-2.5.jar" />
      <include name="external/spring-webmvc-2.5.jar" />
      <include name="external/commons-lang-2.4.jar" />
      <include name="external/jdom.jar" />
    </patternset>
  </fileset>

  <path id="compile.classpath">
    <fileset refid="compile.libraries" />
    <pathelement location="${thredds.classes.dir}"/>
  </path>

  <target name="init">
    <mkdir dir="${build.classes.dir}"/>
    <echo message="Initialize ${ant.project.name}"/>
  </target>
  
  <target name="clean" description="Deletes all files that are generated by the build.">
    <delete dir="${build.dir}" failonerror="false"/>
  </target>

  <target name="compile" depends="init" description="compile nciso for TDS">
    <javac destdir="${build.classes.dir}" source="1.6" target="1.6"
           debug="${javac.debug}" debuglevel="${javac.debuglevel}"
           includeAntRuntime="false">
      <src refid="source.path"/>
      <patternset refid="sources"/>
      <classpath refid="compile.classpath"/>
    </javac>
  </target>

  <property name="nciso.jar" value="${build.dir}/nciso.jar" />
  <property name="nciso.src.jar" value="${build.dir}/nciso-src.jar" />

  <target  name="buildNcisoJar" description="Create nciso.jar (assumes already compiled).">
    <jar destfile="${nciso.jar}">
      <fileset dir="${build.classes.dir}"/>

      <manifest>
        <attribute name="Built-By" value="Unidata - ${user.name}"/>
        <attribute name="Built-On" value="${build.time}"/>
        <attribute name="Implementation-Title" value="ncISO for TDS"/>
        <attribute name="Implementation-Version" value="${ncisoForTds.release.version}"/>
        <attribute name="Implementation-Vendor" value="NOAA/NGDC"/>
      </manifest>
    </jar>
  </target>

  <target  name="buildNcisoSrc" description="Create nciso-src.jar.">
    <jar destfile="${nciso.src.jar}">
      <fileset dir="${src.dir}"/>

      <manifest>
        <attribute name="Built-By" value="Unidata - ${user.name}"/>
        <attribute name="Built-On" value="${build.time}"/>
        <attribute name="Implementation-Title" value="Source of ncISO for TDS"/>
        <attribute name="Implementation-Version" value="${ncisoForTds.release.version}"/>
        <attribute name="Implementation-Vendor" value="NOAA/NGDC"/>
      </manifest>
    </jar>
  </target>
  <target  name="cleanBuildNcisoSrcAndJar" depends="clean, compile, buildNcisoSrc, buildNcisoJar" />

  <property name="tds.lib.release.dir" value="${thredds.dir}/lib/release" />
  <property name="tds.lib.release.src.dir" value="${tds.lib.release.dir}/source" />

  <target name="pushSrcJarToThreddsWorkingCopy">
    <copy todir="${tds.lib.release.dir}" file="${nciso.jar}"
          preservelastmodified="true" overwrite="true" />
    <copy todir="${tds.lib.release.src.dir}" file="${nciso.src.jar}"
          preservelastmodified="true" overwrite="true" />
  </target>
  <target name="cleanPushSrcJarToThreddsWorkingCopy" depends="cleanBuildNcisoSrcAndJar,pushSrcJarToThreddsWorkingCopy" />

</project>
